<html lang="">
<head>
    <script type="text/javascript" src="api.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <script>
    </script>
    <title>C++ Quiz</title>
</head>
<body>

<div id="app">
    Server state: {{ server_state }} <br/>
    UUID: {{ uuid }} <br/>
    Message: {{ message }} <br/>

    Change your name here: <input type="text" v-model="nickname">
</div>

<script>
    const { createApp, ref } = Vue

    if (!localStorage.getItem('unique_id'))
        localStorage.setItem('unique_id', uuidv4());
    unique_id = localStorage.getItem('unique_id');

    if (!localStorage.getItem('nickname'))
        localStorage.setItem('nickname', 'Anonymous Bastard');
    nickname = localStorage.getItem('nickname');

    let api = null;
    let app = createApp({
        data() {
            return {
                server_state: 'initializing',
                message: '',
                nickname: nickname,
                uuid: unique_id
            }
        },
        watch: {
            nickname(newnick, _) {
                localStorage.setItem('nickname', newnick);
                if (api) {
                    api.send({'msg': 'set_nickname', 'nickname': newnick});
                }
            }
        }
    }).mount('#app')

    api = new API('participant', unique_id, function (status) {
        app.$data.server_state = status;
    }, function (message) {
        if (message['msg'] === 'hello') {
            app.$data.message = message['value'] + "!!!";
            // send nickname in case user updated it during a disconnected state
            api.send({'msg': 'set_nickname', 'nickname': app.$data.nickname});
        }
        else if (message['msg'] === 'set_nickname') {
            app.$data.message = message['value'];
        }
    }, function () {
        api.send({'msg': 'hello'});
    }, function () {});
</script>

</body>
</html>
