<html lang="">
<head>
    <script type="text/javascript" src="api.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <script>
    </script>
    <title>C++ Quiz</title>
</head>
<body>

<div id="app">
    Server state: {{ server_state }} <br/>
    UUID: {{ uuid }} <br/>
    Message: {{ message }} <br/>
    <button v-if="!quiz_started" @click="start_quiz">Start quiz</button>
    <button v-if="quiz_started" @click="stop_quiz">Stop quiz</button>

    <div v-if="quiz_started">
        The quiz has started! quiz_id = {{ quiz_id }}
        <br/>
        Current question ID: {{ current_question_id }}<br/>
        Current question: {{ current_question }}<br/>
        Num questions in set: {{ num_questions }}<br/>
        <button @click="next_question">Next question</button>
    </div>

    <h2>Participants</h2>
    <ul>
        <li v-for="participant in participants">
            {{ participant.nickname }} ({{ participant.unique_id }}, {{ participant.connected }})
        </li>
    </ul>

    <h2>Answers received so far</h2>
    <pre>
        {{ answers }}
    </pre>
</div>

<script>
    const { createApp, ref } = Vue

    if (!localStorage.getItem('unique_id'))
        localStorage.setItem('unique_id', uuidv4());
    unique_id = localStorage.getItem('unique_id');

    if (!localStorage.getItem('nickname'))
        localStorage.setItem('nickname', 'Anonymous Bastard');
    nickname = localStorage.getItem('nickname');

    let api = null;
    let app = createApp({
        data() {
            return {
                server_state: 'initializing',
                message: '',
                uuid: unique_id,
                participants: [],
                quiz_started: false,
                current_question: {},
                current_question_id: -1,
                quiz_id: '',
                num_questions: 0,
                answers: {},
            }
        },
        methods: {
            start_quiz() {
                if (app.$data.quiz_id === '') {
                    app.$data.quiz_id = uuidv4();
                }
                api.send({'msg': 'start_quiz', 'quiz_id': app.$data.quiz_id});
            },
            stop_quiz() {
                api.send({'msg': 'stop_quiz'});
            },
            next_question() {
                api.send({'msg': 'next_question'});
            },
        },
        watch: {
        }
    }).mount('#app')

    api = new API('quizmaster', unique_id, function (status) {
        app.$data.server_state = status;
    }, function (message) {
        console.log(message);
        if (message['msg'] === 'hello') {
            app.$data.message = message['value'];
            app.$data.quiz_started = message['quiz_started'];
            app.$data.quiz_id = message['quiz_id'];
            app.$data.current_question = message['current_question'];
            app.$data.current_question_id = message['current_question_id'];
            app.$data.num_questions = message['num_questions'];
        }
        else if (message['msg'] === 'participants') {
            app.$data.participants = message['value'];
        }
        else if (message['msg'] === 'quiz_started') {
            app.$data.quiz_started = message['value'];
        }
        else if (message['msg'] === 'set_question') {
            app.$data.current_question = message["value"];
            try {
                app.$data.current_question_id = app.$data.current_question.question_id;
            } catch (e) {}
        }
        else if (message['msg'] === 'answers_updated') {
            app.$data.answers = message['value'];
        }
    }, function () {
        api.send({'msg': 'hello'});
    }, function () {});
</script>

</body>
</html>
